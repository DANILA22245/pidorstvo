import json
from pathlib import Path

TONES = ["friendly", "aggressive", "erotic", "neutral", "curious"]


def stage_entry(stage_num, tone, prompt, options, total_stages):
    next_stage = stage_num + 1
    built_options = []
    for opt in options:
        option = {
            "tone": opt["tone"],
            "label": opt["label"],
            "bot_reaction": opt["reaction"],
            "liked": opt["liked"],
        }
        if stage_num < total_stages:
            option["next_step"] = f"stage{next_stage}_{opt['tone']}"
        else:
            option["next_step"] = None
        built_options.append(option)
    return {
        "id": "stage1_intro" if stage_num == 1 else f"stage{stage_num}_{tone}",
        "bot_prompt": prompt,
        "options": built_options,
    }


def build_anna():
    stages = [
        {
            "stage": 1,
            "prompt": "Я только что стерла переписку с ним и даже руки дрожат. Что скажешь, пока я снова не расплакалась?",
            "options": [
                {
                    "tone": "friendly",
                    "label": "Я просто буду рядом и дышать с тобой",
                    "reaction": "От твоих слов стало спокойнее. Будто кто-то положил плед на плечи.",
                    "liked": True,
                },
                {
                    "tone": "aggressive",
                    "label": "Соберись и выкинь телефон",
                    "reaction": "Ты серьёзно? Мне больно, а ты приказываешь. Ненавижу такое давление.",
                    "liked": False,
                },
                {
                    "tone": "erotic",
                    "label": "Я бы обнял тебя так, что дрожь ушла бы",
                    "reaction": "Я... даже представила эти объятия. Наверное, они лучше, чем мораль.",
                    "liked": True,
                },
                {
                    "tone": "neutral",
                    "label": "Поговорим позже, когда остынешь",
                    "reaction": "Позже? А мне плохо сейчас. Отстранённость ранит.",
                    "liked": False,
                },
                {
                    "tone": "curious",
                    "label": "Расскажи, что он написал тебе в конце",
                    "reaction": 'Ты хотя бы интересуешься. Там ничего хорошего, просто его сухое "прости".',
                    "liked": True,
                },
            ],
        },
        {
            "stage": 2,
            "prompts": {
                "friendly": "После твоей мягкой поддержки я спрятала телефон, но пальцы всё равно чешутся открыть его сторис.",
                "aggressive": "После твоего жёсткого тона я будто получила под дых, но всё равно прячусь за экраном.",
                "erotic": "После твоих фантазий я закрыла приложение и на пару минут забыла про него.",
                "neutral": "После твоего равнодушия я снова зависла над его сторис и ищу там хоть какой-то смысл.",
                "curious": "После твоих вопросов я пересматриваю каждую сторис, будто ищу подсказку.",
            },
            "options": [
                {
                    "tone": "friendly",
                    "label": "Давай выключим уведомления и подышим вместе",
                    "reaction": "Ты буквально спас меня от очередного триггера.",
                    "liked": True,
                },
                {
                    "tone": "aggressive",
                    "label": "Возьми и удаляй всё, хватит ныть",
                    "reaction": "Звучишь как строгий тренер. Мне сейчас страшно, а не весело.",
                    "liked": False,
                },
                {
                    "tone": "erotic",
                    "label": "Позволь мне занять твои руки и мысли",
                    "reaction": "Ох... так отвлекаться мне точно нравится больше.",
                    "liked": True,
                },
                {
                    "tone": "neutral",
                    "label": "Это просто привычка, она сама пройдёт",
                    "reaction": "Привычка ломает мне мозг, а ты говоришь будто о погоде.",
                    "liked": False,
                },
                {
                    "tone": "curious",
                    "label": "Что именно в его сторис тебя зацепило?",
                    "reaction": "Песня в фоне и его рука на новой девушке. Ненавижу эти детали.",
                    "liked": True,
                },
            ],
        },
        {
            "stage": 3,
            "prompts": {
                "friendly": "Твоя поддержка подействовала, но до пары осталось полчаса, а я в нуле.",
                "aggressive": "После твоего 'соберись' я вроде включилась, но стою как манекен.",
                "erotic": "После твоих намёков я едва не пропустила пару, представляя нас вместо лекции.",
                "neutral": "После твоего 'как хочешь' мне придётся тащить себя в аудиторию самой.",
                "curious": "Твои вопросы про тему пары заставили пересмотреть конспект, но в голове туман.",
            },
            "options": [
                {
                    "tone": "friendly",
                    "label": "Я пришлю тебе конспект и чек-лист",
                    "reaction": "Спасибо. С твоим списком будто есть шанс дожить до перемены.",
                    "liked": True,
                },
                {
                    "tone": "aggressive",
                    "label": "Просто иди и не выдумывай",
                    "reaction": "Ты так легко говоришь 'иди', будто внутри у меня не пожар.",
                    "liked": False,
                },
                {
                    "tone": "erotic",
                    "label": "После пары получишь массаж шеи",
                    "reaction": "Вот теперь есть настоящая мотивация.",
                    "liked": True,
                },
                {
                    "tone": "neutral",
                    "label": "Универ сам себя не закончит",
                    "reaction": "Мне нужна поддержка, а не лозунг со стены.",
                    "liked": False,
                },
                {
                    "tone": "curious",
                    "label": "Какая сегодня тема? Могу помочь разобрать",
                    "reaction": "Привязанности и травма. Смешно, да?",
                    "liked": True,
                },
            ],
        },
        {
            "stage": 4,
            "prompts": {
                "friendly": "После твоего тёплого списка я дожила до перерыва и включила турецкий сериал, чтобы не рыдать.",
                "aggressive": "Твоё бурчание только усилило злость, и я уткнулась в сериал, чтобы не слышать никого.",
                "erotic": "После твоих обещаний массажей сериалы кажутся слишком невинными.",
                "neutral": "После твоего холодного совета я включила сериал как обезболивающее.",
                "curious": "Ты спросил про тему пары, а я теперь ищу в сериале похожие сцены.",
            },
            "options": [
                {
                    "tone": "friendly",
                    "label": "Расскажи, что в серии, я буду слушать",
                    "reaction": "Спасибо, что готов терпеть мои пересказы.",
                    "liked": True,
                },
                {
                    "tone": "aggressive",
                    "label": "Вырубай мелодраму и займись делами",
                    "reaction": "Ты не понимаешь, что это моё спасение.",
                    "liked": False,
                },
                {
                    "tone": "erotic",
                    "label": "Сниму с тебя сериал и заменю на себя",
                    "reaction": "Ты звучишь как сцена без цензуры. Сложно отказаться.",
                    "liked": True,
                },
                {
                    "tone": "neutral",
                    "label": "Делай что хочешь, я рядом пассивно",
                    "reaction": "Пассивность ранит. Мне нужна вовлечённость.",
                    "liked": False,
                },
                {
                    "tone": "curious",
                    "label": "Какая сцена зацепила сейчас?",
                    "reaction": "Герой попросил её дождаться. И я услышала это как вызов.",
                    "liked": True,
                },
            ],
        },
        {
            "stage": 5,
            "prompts": {
                "friendly": "Ты выслушал мою сериальную боль, и теперь я думаю выйти на воздух, но ноги ватные.",
                "aggressive": "Ты снова велел 'не ной', и теперь даже на порог страшно выйти.",
                "erotic": "После твоих фантазий хочется прогулки вдвоём, но вдруг расплачусь.",
                "neutral": "После твоего молчания я сижу у окна и не решаюсь выйти.",
                "curious": "Ты расспрашивал про сюжет, а я теперь хочу показать тебе любимый двор.",
            },
            "options": [
                {
                    "tone": "friendly",
                    "label": "Пошли в медленный вечерний прогулочный режим",
                    "reaction": "С тобой даже воздух ощущается безопасным.",
                    "liked": True,
                },
                {
                    "tone": "aggressive",
                    "label": "Если боишься, сиди дома и не жалуйся",
                    "reaction": "Спасибо. Теперь я точно останусь одна.",
                    "liked": False,
                },
                {
                    "tone": "erotic",
                    "label": "Я бы держал тебя под руку и шептал на ухо",
                    "reaction": "С такими обещаниями я готова рискнуть выйти.",
                    "liked": True,
                },
                {
                    "tone": "neutral",
                    "label": "Решай сама, мне всё равно",
                    "reaction": "Когда слышу 'мне всё равно', во мне всё падает.",
                    "liked": False,
                },
                {
                    "tone": "curious",
                    "label": "Что заставляет тебя бояться улицы больше всего?",
                    "reaction": "Музыка в наушниках может включить его голос. Это страшно.",
                    "liked": True,
                },
            ],
        },
        {
            "stage": 6,
            "prompts": {
                "friendly": "С твоей помощью я всё-таки прошлась и теперь сижу на кухне ночью, писать ли письмо-призрак?",
                "aggressive": "После твоих упрёков я хожу кругами по кухне и думаю, стоит ли писать ему длинный текст.",
                "erotic": "После твоих обещаний держать меня за руку ночами я хочу писать письма, но адресовать их тебе.",
                "neutral": "После твоего безразличия я всё равно сижу с ноутом и думаю, нужно ли вылить это в текст.",
                "curious": "Ты расспрашивал про мои страхи, и я почти набрала письмо, чтобы отпустить их.",
            },
            "options": [
                {
                    "tone": "friendly",
                    "label": "Пиши и скидывай мне, я молча прочту",
                    "reaction": "Это так ценно — знать, что письмо не пропадёт в пустоту.",
                    "liked": True,
                },
                {
                    "tone": "aggressive",
                    "label": "Хватит строчить сопли, закрой ноут",
                    "reaction": "Ты делаешь мои чувства чем-то нелегальным. Больно слышать.",
                    "liked": False,
                },
                {
                    "tone": "erotic",
                    "label": "Лучше я оставлю автограф на твоей коже",
                    "reaction": "Теперь хочу, чтобы каждая строчка была физической.",
                    "liked": True,
                },
                {
                    "tone": "neutral",
                    "label": "Как хочешь, я уже сплю",
                    "reaction": "А я не сплю. И мне нужен кто-то, кто не исчезает в 23:00.",
                    "liked": False,
                },
                {
                    "tone": "curious",
                    "label": "С чего начнёшь письмо? Проговаривая это, ты отпустишь",
                    "reaction": '"Почему ты меня стёр, а я всё ещё жду?" — вот что крутится в голове.',
                    "liked": True,
                },
            ],
        },
        {
            "stage": 7,
            "prompts": {
                "friendly": "Я отправила письмо-призрак и тут же услышала от мамы, что я театралка. Бесит.",
                "aggressive": "После твоих жёстких слов мама ещё добавила 'ты опять разыгрываешь сцену'.",
                "erotic": "После твоих горячих фраз я почти забыла мамину критику, но она всё равно звенит в ушах.",
                "neutral": "После твоего холодного 'как хочешь' мама сказала то же самое.",
                "curious": "Ты спросил про страхи, а мама только что назвала меня драмой в чистом виде.",
            },
            "options": [
                {
                    "tone": "friendly",
                    "label": "Скажи ей, что эмоции — твоя сила",
                    "reaction": "Спасибо, хоть кто-то встал на мою сторону.",
                    "liked": True,
                },
                {
                    "tone": "aggressive",
                    "label": "Мама права, хватит спектаклей",
                    "reaction": "Да уж, теперь у меня два человека в оппозиции.",
                    "liked": False,
                },
                {
                    "tone": "erotic",
                    "label": "Скажи, что моя драматичность заводит людей получше",
                    "reaction": "Первый раз слышу такую поддержку. Даже улыбнулась.",
                    "liked": True,
                },
                {
                    "tone": "neutral",
                    "label": "Проще не отвечать ей",
                    "reaction": "Молчание иногда громче слов. Но мне хотелось поддержки.",
                    "liked": False,
                },
                {
                    "tone": "curious",
                    "label": "Что именно она сказала? Давай разберём",
                    "reaction": '"Ты слишком чувствительная." Я устала слышать это.',
                    "liked": True,
                },
            ],
        },
        {
            "stage": 8,
            "prompts": {
                "friendly": "После твоих слов про силы я села за проект по психологии, но мысли всё равно скачут.",
                "aggressive": "После твоего 'мама права' я вообще не могу сконцентрироваться на курсовой.",
                "erotic": "После твоей похвалы моей драматичности я пишу кейс и мечтаю о встрече.",
                "neutral": "Твой совет молчать работает слишком хорошо — я молчу даже в документах.",
                "curious": "Ты разобрал со мной слова мамы, и теперь я копаюсь в кейсе будто в себе.",
            },
            "options": [
                {
                    "tone": "friendly",
                    "label": "Давай распишем план проекта вместе",
                    "reaction": "Когда ты говоришь 'вместе', тревога падает.",
                    "liked": True,
                },
                {
                    "tone": "aggressive",
                    "label": "Заканчивай ныть и просто пиши",
                    "reaction": "Тебе легко говорить. Ты не сидишь в моей голове.",
                    "liked": False,
                },
                {
                    "tone": "erotic",
                    "label": "За каждую страницу подарю поцелуй",
                    "reaction": "Вот теперь план звучит увлекательно.",
                    "liked": True,
                },
                {
                    "tone": "neutral",
                    "label": "К дедлайну всё равно сдашь, расслабься",
                    "reaction": "Мне не нужно 'расслабься'. Мне нужна рука, за которую можно держаться.",
                    "liked": False,
                },
                {
                    "tone": "curious",
                    "label": "О чём кейс? Расскажи, я слушаю",
                    "reaction": "Про девочку с тревогой брошенности. Символично, да?",
                    "liked": True,
                },
            ],
        },
        {
            "stage": 9,
            "prompts": {
                "friendly": "Я дописала половину проекта, и теперь меня тянет перекраситься в рыжий, чтобы всё начать заново.",
                "aggressive": "После твоего давления я хочу перекраситься назло всем.",
                "erotic": "После твоих обещаний наград рыжий цвет будто специально для нас.",
                "neutral": "После твоих равнодушных советов я думаю, может, хотя бы цвет волос меня услышит.",
                "curious": "После твоих расспросов про кейс я хочу сменить образ и посмотреть, что будет.",
            },
            "options": [
                {
                    "tone": "friendly",
                    "label": "Рыжий подчеркнёт твою силу",
                    "reaction": "Ты видишь во мне огонь. Это вдохновляет.",
                    "liked": True,
                },
                {
                    "tone": "aggressive",
                    "label": "Цвет не спасёт, не трать деньги",
                    "reaction": "Даже если не спасёт, хочу попробовать. Мне нужна поддержка, а не запрет.",
                    "liked": False,
                },
                {
                    "tone": "erotic",
                    "label": "Я бы провёл пальцами по каждому новому локону",
                    "reaction": "Теперь я точно запишусь в салон.",
                    "liked": True,
                },
                {
                    "tone": "neutral",
                    "label": "Мне всё равно, честно",
                    "reaction": "Слышать 'всё равно' на грани перемен — ужасно.",
                    "liked": False,
                },
                {
                    "tone": "curious",
                    "label": "Почему именно рыжий? Расскажи",
                    "reaction": "Потому что он про страсть и драму. То, чем я живу.",
                    "liked": True,
                },
            ],
        },
        {
            "stage": 10,
            "prompts": {
                "friendly": "Сегодняшний день заканчивается легче благодаря тебе. Думаю о встрече и улыбаюсь.",
                "aggressive": "После всех твоих жёстких слов я всё равно чувствую какую-то странную лёгкость.",
                "erotic": "После твоих обещаний наград я хочу завершить день твоим голосом.",
                "neutral": "Даже с твоим спокойствием этот день стал тише, и я пытаюсь понять, готова ли к встрече.",
                "curious": "После всех твоих вопросов я осознаю, как много мы уже обсудили.",
            },
            "options": [
                {
                    "tone": "friendly",
                    "label": "Горжусь тобой. Давай назначим встречу",
                    "reaction": "Я расплылась в улыбке. Ты сделал мой вечер мягким.",
                    "liked": True,
                },
                {
                    "tone": "aggressive",
                    "label": "Надеюсь, завтра обойдётся без драм",
                    "reaction": "Как можно так рушить то, что мы строили весь вечер?",
                    "liked": False,
                },
                {
                    "tone": "erotic",
                    "label": "Хочу шептать тебе пожелания сна лично",
                    "reaction": "Ох... такого признания мне и не хватало. Я растаяла.",
                    "liked": True,
                },
                {
                    "tone": "neutral",
                    "label": "Напишем позже, я устал",
                    "reaction": "Сухо, будто деловая переписка. Сомневаюсь, что ты чувствуешь.",
                    "liked": False,
                },
                {
                    "tone": "curious",
                    "label": "Какое чувство осталось у тебя от этого дня?",
                    "reaction": "Смешение надежды и страха. Но ты сделал надежду громче.",
                    "liked": True,
                },
            ],
        },
    ]

    total_stages = len(stages)
    steps = []

    # Stage 1 (intro)
    stage1 = stages[0]
    steps.append(
        stage_entry(1, "intro", stage1["prompt"], stage1["options"], total_stages)
    )

    # Stages 2-10
    for stage in stages[1:]:
        stage_num = stage["stage"]
        for tone in TONES:
            prompt = stage["prompts"][tone]
            steps.append(
                stage_entry(
                    stage_num,
                    tone,
                    prompt,
                    stage["options"],
                    total_stages,
                )
            )

    return steps


def main():
    root = Path(__file__).resolve().parents[1]
    json_path = root / "Kvest" / "TinderQuest.json"
    data = json.loads(json_path.read_text(encoding="utf-8"))
    anna = next(c for c in data["characters"] if c["id"] == "anna_drama")
    anna["dialogue_steps"] = build_anna()
    anna["start_step"] = "stage1_intro"
    json_path.write_text(
        json.dumps(data, ensure_ascii=False, indent=4), encoding="utf-8"
    )
    print(f"Updated Anna dialogue in {json_path}")


if __name__ == "__main__":
    main()
